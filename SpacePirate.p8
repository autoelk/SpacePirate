pico-8 cartridge // http://www.pico-8.com
version 16
__lua__

function _init()
  gamestage = "space"
  gravity = 0.2
	player = {}
	stars = {}
	numstars = 10
	for i=1,numstars do
		stars[i] = starcreate()
	end
  spawn()
end

function starcreate(x, y, r, s)
	local star = {}
	star.x = x or rnd(134)
	star.y = y or rnd(134)
	star.r = r or rnd(2) + 0.1
	star.s = s or rnd(1) + 1
	return star
end

function _update()
  if gamestage == "space" then
		-- player movement
		player.vx = 0
		player.vy = 0
    if btn(0) then
      player.vx = -player.speed
    end
    if btn(1) then
      player.vx = player.speed
    end
    if btn(2) then
      player.vy = -player.speed
    end
    if btn(3) then
      player.vy = player.speed
    end
		-- star movement
		for i = 1, numstars do
			if stars[i].x > 128 + stars[i].r * 2 then
				stars[i] = starcreate(-stars[i].r * 3)
			end
			if stars[i].x < -stars[i].r * 3 then
				stars[i] = starcreate(128 + stars[i].r * 2)
			end
			if stars[i].y > 128 + stars[i].r * 2 then
				stars[i] = starcreate(rnd(134), -stars[i].r * 3)
			end
			if stars[i].y < -stars[i].r * 3 then
				stars[i] = starcreate(rnd(128 + stars[i].r * 2), 128 + stars[i].r * 2)
			end
			stars[i].x -= player.vx * stars[i].s
			stars[i].y -= player.vy * stars[i].s
		end
  end
  if gamestage == "platform" then
    --jump
    if btnp(2) and player.isgrounded then
      player.vy = -player.jumpheight
    end

    --walk
    player.vx = 0
    if btn(0) then --left
      player.vx = -player.speed
    elseif btn(1) then --right
      player.vx = player.speed
    end
    player.x += player.vx

    if check_tile(0, 7, 0) or check_tile(0, 7, 7) then --moving right
      player.x = flr(player.x / 8) * 8
      player.vx = 0
    end
    if check_tile(1, 6, 2) or check_tile(1, 6, 6) then
      spawn()
    end
    if check_tile(0, 0, 0) or check_tile(0, 0, 7) then --moving left
      player.x = flr((player.x + 8) / 8) * 8
      player.vx = 0
    end
    if check_tile(1, 2, 2) or check_tile(1, 2, 6) then
      spawn()
    end
    player.vy += gravity
    player.y += player.vy
    player.isgrounded = false
    if player.vy >= 0 then
      if check_tile(0, 0, 8) or check_tile(0, 7, 8) then --falling
        player.y = flr(player.y / 8) * 8
        player.vy = 0
        player.isgrounded = true
      end
      if check_tile(1, 2, 6) or check_tile(1, 6, 6) then
        spawn()
      end
    end
    if player.vy <= 0 then
      if check_tile(0, 0, 0) or check_tile(0, 7, 0) then --jumping
        player.y = flr((player.y + 8) / 8) * 8
        player.vy = 0
      end
      if check_tile(1, 2, 2) or check_tile(1, 6, 2) then
        spawn()
      end
    end
    if player.x < -8 then
      gamestage = "space"
      spawn()
    end
  end
end


function _draw()
  cls() --clear the screen
  if gamestage == "space" then
		for i = 1, numstars do
			circfill(stars[i].x, stars[i].y, stars[i].r)
		end
    spr(64, 60, 60)
  end
  if gamestage == "platform" then
    rectfill(0, 0, 128, 128, 12)
  	if player.x <= 60 then --don't track if at left edge
  		map(0, 0, 0, 0, 128, 128)
  		spr(1, player.x, player.y)
  	elseif player.x >= 148 then --don't track if at right edge
  		map(0, 0, -88, 0, 128, 128)
  		spr(1, player.x - 88, player.y)
  	else
  		map(0, 0, -player.x + 60, 0, 128, 128)
  		spr(1, 60, player.y)
  	end
  	print(player.x, 0, 0, 7)
  	print(player.y, 0, 7, 7)
  end
end

function check_tile(flag, offsetx, offsety)
  return fget(mget((player.x + offsetx) / 8, (player.y + offsety) / 8), flag)
end

function spawn()
  if gamestage == "space" then
    --position
    player.x = 60
    player.y = 60
    --velocity
    player.vx = 0
    player.vy = 0
    player.speed = 2
  end
  if gamestage == "platform" then
    --position
    player.x = 0
    player.y = 112
    --velocity
    player.vx = 0
    player.vy = 0
    player.isgrounded = false
    player.jumpheight = 3.4
    player.speed = 2
  end
end

__gfx__
00000000888888882eeeeeea00000000000000000007700000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000899999981222222e0000000000aaaa000077770000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700898998981222222e000000000a9aa9a00776677000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000898998981222222e000000000aa99aa07766667700000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000899999981222222e000000000aa99aa07665566700000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700898888981222222e000000000a9aa9a06655556600000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000899999981222222e0000000000aaaa006555555600000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000888888881111111200000000000000005555555500000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
111cc111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11cccc11000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11cccc11000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
111cc111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000010104020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0202020202020202020202020202020202020202020202020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000040000000002000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000202020200000000000000000000000202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020200000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000000000202020202000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000005000000000000000000000000000000000002020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000020202000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000005000000000000000002020000000000000002020000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000050000000500000000020202000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000020200000000000000000002000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000202020200000000000000000000000000000002000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000002000000000000000202050502000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000502050205050005000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202050505020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
